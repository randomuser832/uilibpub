local Library = {}

Library.flags = {}
Library.windowCount = 0

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Helper to safely call user callbacks with error catching
local function safeCall(func, ...)
    local success, err = pcall(func, ...)
    if not success then
        warn("[Library Error]: Callback error - " .. tostring(err))
    end
end

local function ClickEffect(guiObject)
    local circle = Instance.new("ImageLabel")
    circle.Name = "ClickEffect"
    circle.Image = "rbxassetid://3926307971"
    circle.ImageRectOffset = Vector2.new(524, 764)
    circle.ImageRectSize = Vector2.new(36, 36)
    circle.BackgroundTransparency = 1
    circle.AnchorPoint = Vector2.new(0.5, 0.5)
    circle.Position = UDim2.new(0.5, 0, 0.5, 0)
    circle.Size = UDim2.new(0, 0, 0, 0)
    circle.ZIndex = guiObject.ZIndex + 1
    circle.Parent = guiObject

    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Linear)
    local tweenSize = TweenService:Create(circle, tweenInfo, {Size = UDim2.new(1, 0, 1, 0), ImageTransparency = 1})
    tweenSize:Play()

    tweenSize.Completed:Connect(function()
        circle:Destroy()
    end)
end

local function Drag(gui)
    local dragging, dragInput, dragStart, startPos

    gui.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = gui.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    gui.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            local newX = math.clamp(startPos.X.Offset + delta.X, 0, workspace.CurrentCamera.ViewportSize.X - gui.AbsoluteSize.X)
            local newY = math.clamp(startPos.Y.Offset + delta.Y, 0, workspace.CurrentCamera.ViewportSize.Y - gui.AbsoluteSize.Y)
            gui.Position = UDim2.new(startPos.X.Scale, newX, startPos.Y.Scale, newY)
        end
    end)
end

function Library:Window(title)
    self.windowCount = self.windowCount + 1

    local windowFrame = Instance.new("Frame")
    windowFrame.Name = "Window" .. self.windowCount
    windowFrame.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
    windowFrame.BorderSizePixel = 0
    windowFrame.Position = UDim2.new(0, 25, 0, -30 + 36 * self.windowCount + 6 * self.windowCount)
    windowFrame.Size = UDim2.new(0, 212, 0, 36)
    windowFrame.ZIndex = 10
    windowFrame.Parent = game.CoreGui

    Drag(windowFrame)

    local windowLine = Instance.new("Frame", windowFrame)
    windowLine.Name = "WindowLine"
    windowLine.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    windowLine.BorderSizePixel = 0
    windowLine.Position = UDim2.new(0, 0, 0, 34)
    windowLine.Size = UDim2.new(0, 212, 0, 2)

    local lineGradient = Instance.new("UIGradient", windowLine)
    lineGradient.Color = ColorSequence.new {
        ColorSequenceKeypoint.new(0.00, Color3.fromRGB(43, 43, 43)),
        ColorSequenceKeypoint.new(0.20, Color3.fromRGB(43, 43, 43)),
        ColorSequenceKeypoint.new(0.50, Color3.fromRGB(131, 132, 255)),
        ColorSequenceKeypoint.new(0.80, Color3.fromRGB(43, 43, 43)),
        ColorSequenceKeypoint.new(1.00, Color3.fromRGB(43, 43, 43))
    }

    local header = Instance.new("TextLabel", windowFrame)
    header.Name = "Header"
    header.BackgroundTransparency = 1
    header.Position = UDim2.new(0, 0, 0, 0)
    header.Size = UDim2.new(0, 54, 0, 34)
    header.Font = Enum.Font.GothamSemibold
    header.Text = "   " .. tostring(title)
    header.TextColor3 = Color3.fromRGB(255, 255, 255)
    header.TextSize = 14
    header.TextXAlignment = Enum.TextXAlignment.Left

    local toggleButton = Instance.new("TextButton", windowFrame)
    toggleButton.Name = "WindowToggle"
    toggleButton.BackgroundTransparency = 1
    toggleButton.Position = UDim2.new(0.835, 0, 0, 0)
    toggleButton.Size = UDim2.new(0, 34, 0, 34)
    toggleButton.Text = ""
    toggleButton.AutoButtonColor = false

    local toggleImage = Instance.new("ImageLabel", toggleButton)
    toggleImage.Name = "WindowToggleImg"
    toggleImage.AnchorPoint = Vector2.new(0.5, 0.5)
    toggleImage.BackgroundTransparency = 1
    toggleImage.Position = UDim2.new(0.5, 0, 0.5, 0)
    toggleImage.Size = UDim2.new(0, 18, 0, 18)
    toggleImage.Image = "rbxassetid://3926305904"
    toggleImage.ImageRectOffset = Vector2.new(524, 764)
    toggleImage.ImageRectSize = Vector2.new(36, 36)
    toggleImage.Rotation = 180

    local bottomFrame = Instance.new("Frame", windowFrame)
    bottomFrame.Name = "Bottom"
    bottomFrame.BackgroundColor3 = Color3.fromRGB(38, 38, 38)
    bottomFrame.BorderSizePixel = 0
    bottomFrame.ClipsDescendants = true
    bottomFrame.Position = UDim2.new(0, 0, 1, 0)
    bottomFrame.Size = UDim2.new(0, 212, 0, 0)

    local bottomLayout = Instance.new("UIListLayout", bottomFrame)
    bottomLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    bottomLayout.SortOrder = Enum.SortOrder.LayoutOrder
    bottomLayout.Padding = UDim.new(0, 4)

    local tabButtonsFrame = Instance.new("Frame", bottomFrame)
    tabButtonsFrame.Name = "TabButtons"
    tabButtonsFrame.BackgroundTransparency = 1
    tabButtonsFrame.Size = UDim2.new(1, 0, 0, 36)
    tabButtonsFrame.ClipsDescendants = true

    local tabButtonsLayout = Instance.new("UIListLayout", tabButtonsFrame)
    tabButtonsLayout.FillDirection = Enum.FillDirection.Horizontal
    tabButtonsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tabButtonsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabButtonsLayout.Padding = UDim.new(0, 6)

    local tabs = {}
    local currentTabContent = nil

    local function resizeBottom()
        if currentTabContent then
            local contentSize = currentTabContent.Layout.AbsoluteContentSize.Y
            local targetHeight = 36 + contentSize + 8
            bottomFrame:TweenSize(UDim2.new(0, 212, 0, targetHeight), Enum.EasingDirection.InOut, Enum.EasingStyle.Sine, 0.25, true)
        end
    end

    local opened = false
    toggleButton.MouseButton1Click:Connect(function()
        if opened then
            bottomFrame:TweenSize(UDim2.new(0, 212, 0, 0), Enum.EasingDirection.InOut, Enum.EasingStyle.Sine, 0.25, true)
            TweenService:Create(toggleImage, TweenInfo.new(0.25), {Rotation = 180}):Play()
            opened = false
        else
            if currentTabContent then
                local contentSize = currentTabContent.Layout.AbsoluteContentSize.Y
                local targetHeight = 36 + contentSize + 8
                bottomFrame:TweenSize(UDim2.new(0, 212, 0, targetHeight), Enum.EasingDirection.InOut, Enum.EasingStyle.Sine, 0.25, true)
            else
                bottomFrame:TweenSize(UDim2.new(0, 212, 0, 36), Enum.EasingDirection.InOut, Enum.EasingStyle.Sine, 0.25, true)
            end
            TweenService:Create(toggleImage, TweenInfo.new(0.25), {Rotation = 0}):Play()
            opened = true
        end
    end)

    local windowAPI = {}

    function windowAPI:Tab(name)
        local tabButton = Instance.new("TextButton")
        tabButton.Name = name .. "Button"
        tabButton.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
        tabButton.BorderSizePixel = 0
        tabButton.Size = UDim2.new(0, 72, 1, 0)
        tabButton.Font = Enum.Font.GothamSemibold
        tabButton.Text = name
        tabButton.TextColor3 = Color3.new(1, 1, 1)
        tabButton.TextSize = 14
        tabButton.Parent = tabButtonsFrame
        tabButton.AutoButtonColor = false

        local tabContent = Instance.new("Frame", bottomFrame)
        tabContent.Name = name .. "Content"
        tabContent.BackgroundTransparency = 1
        tabContent.BorderSizePixel = 0
        tabContent.Position = UDim2.new(0, 0, 0, 36)
        tabContent.Size = UDim2.new(1, 0, 0, 0)
        tabContent.Visible = false
        tabContent.ClipsDescendants = true

        local contentLayout = Instance.new("UIListLayout", tabContent)
        contentLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
        contentLayout.Padding = UDim.new(0, 4)
        tabContent.Layout = contentLayout

        tabs[name] = tabContent

        local function activateTab()
            if currentTabContent then
                currentTabContent.Visible = false
                for _, btn in pairs(tabButtonsFrame:GetChildren()) do
                    if btn:IsA("TextButton") then
                        btn.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
                    end
                end
            end
            currentTabContent = tabContent
            tabContent.Visible = true
            tabButton.BackgroundColor3 = Color3.fromRGB(131, 132, 255)

            if opened then
                local contentSize = tabContent.Layout.AbsoluteContentSize.Y
                local targetHeight = 36 + contentSize + 8
                bottomFrame:TweenSize(UDim2.new(0, 212, 0, targetHeight), Enum.EasingDirection.InOut, Enum.EasingStyle.Sine, 0.25, true)
            end
        end

        tabButton.MouseButton1Click:Connect(function()
            safeCall(activateTab)
        end)

        if not currentTabContent then
            activateTab()
        end

        local tabAPI = {}

        function tabAPI:Button(text, callback)
            local buttonFrame = Instance.new("Frame")
            buttonFrame.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            buttonFrame.Size = UDim2.new(0, 212, 0, 24)
            buttonFrame.BorderSizePixel = 0
            buttonFrame.LayoutOrder = #tabContent:GetChildren() + 1
            buttonFrame.Parent = tabContent

            local button = Instance.new("TextButton")
            button.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            button.BorderSizePixel = 0
            button.Position = UDim2.new(0, 0, 0, 0)
            button.Size = UDim2.new(1, 0, 1, 0)
            button.Font = Enum.Font.GothamSemibold
            button.Text = text
            button.TextColor3 = Color3.new(1, 1, 1)
            button.TextSize = 14
            button.Parent = buttonFrame
            button.AutoButtonColor = false

            button.MouseButton1Click:Connect(function()
                ClickEffect(button)
                safeCall(callback)
            end)

            return button
        end

        function tabAPI:Toggle(text, default, callback)
            local toggleFrame = Instance.new("Frame")
            toggleFrame.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            toggleFrame.Size = UDim2.new(0, 212, 0, 24)
            toggleFrame.BorderSizePixel = 0
            toggleFrame.LayoutOrder = #tabContent:GetChildren() + 1
            toggleFrame.Parent = tabContent

            local toggleButton = Instance.new("TextButton")
            toggleButton.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            toggleButton.BorderSizePixel = 0
            toggleButton.Position = UDim2.new(0, 4, 0, 2)
            toggleButton.Size = UDim2.new(0, 20, 0, 20)
            toggleButton.Font = Enum.Font.SourceSans
            toggleButton.Text = ""
            toggleButton.Parent = toggleFrame
            toggleButton.AutoButtonColor = false

            local checkmark = Instance.new("ImageLabel")
            checkmark.BackgroundTransparency = 1
            checkmark.Image = "rbxassetid://3926305904"
            checkmark.ImageRectOffset = Vector2.new(628, 316)
            checkmark.ImageRectSize = Vector2.new(24, 24)
            checkmark.Size = UDim2.new(1, 0, 1, 0)
            checkmark.Visible = default
            checkmark.Parent = toggleButton

            local label = Instance.new("TextLabel")
            label.BackgroundTransparency = 1
            label.Position = UDim2.new(0, 28, 0, 0)
            label.Size = UDim2.new(1, -28, 1, 0)
            label.Font = Enum.Font.GothamSemibold
            label.Text = text
            label.TextColor3 = Color3.new(1, 1, 1)
            label.TextSize = 14
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = toggleFrame

            local toggled = default
            Library.flags[text] = toggled

            toggleButton.MouseButton1Click:Connect(function()
                toggled = not toggled
                Library.flags[text] = toggled
                checkmark.Visible = toggled
                safeCall(callback, toggled)
            end)

            return toggleButton
        end

        function tabAPI:Slider(text, min, max, default, callback)
            local sliderFrame = Instance.new("Frame")
            sliderFrame.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            sliderFrame.Size = UDim2.new(0, 212, 0, 32)
            sliderFrame.BorderSizePixel = 0
            sliderFrame.LayoutOrder = #tabContent:GetChildren() + 1
            sliderFrame.Parent = tabContent

            local label = Instance.new("TextLabel")
            label.BackgroundTransparency = 1
            label.Position = UDim2.new(0, 4, 0, 0)
            label.Size = UDim2.new(0, 100, 0, 14)
            label.Font = Enum.Font.GothamSemibold
            label.Text = text
            label.TextColor3 = Color3.new(1, 1, 1)
            label.TextSize = 14
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = sliderFrame

            local valueLabel = Instance.new("TextLabel")
            valueLabel.BackgroundTransparency = 1
            valueLabel.Position = UDim2.new(1, -52, 0, 0)
            valueLabel.Size = UDim2.new(0, 48, 0, 14)
            valueLabel.Font = Enum.Font.GothamSemibold
            valueLabel.Text = tostring(default)
            valueLabel.TextColor3 = Color3.new(1, 1, 1)
            valueLabel.TextSize = 14
            valueLabel.TextXAlignment = Enum.TextXAlignment.Right
            valueLabel.Parent = sliderFrame

            local sliderBar = Instance.new("Frame")
            sliderBar.BackgroundColor3 = Color3.fromRGB(67, 67, 67)
            sliderBar.Position = UDim2.new(0, 4, 0, 18)
            sliderBar.Size = UDim2.new(1, -8, 0, 8)
            sliderBar.BorderSizePixel = 0
            sliderBar.Parent = sliderFrame

            local fillBar = Instance.new("Frame")
            fillBar.BackgroundColor3 = Color3.fromRGB(131, 132, 255)
            fillBar.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
            fillBar.BorderSizePixel = 0
            fillBar.Parent = sliderBar

            local dragging = false

            local function updateValue(inputPosX)
                local relativeX = math.clamp(inputPosX - sliderBar.AbsolutePosition.X, 0, sliderBar.AbsoluteSize.X)
                local percent = relativeX / sliderBar.AbsoluteSize.X
                local value = math.floor(min + (max - min) * percent + 0.5)
                fillBar.Size = UDim2.new(percent, 0, 1, 0)
                valueLabel.Text = tostring(value)
                Library.flags[text] = value
                safeCall(callback, value)
            end

            sliderBar.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    updateValue(input.Position.X)
                end
            end)

            sliderBar.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    updateValue(input.Position.X)
                end
            end)

            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)

            Library.flags[text] = default

            return sliderFrame
        end

        function tabAPI:Dropdown(text, items, defaultIndex, callback)
            local dropdownFrame = Instance.new("Frame")
            dropdownFrame.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            dropdownFrame.Size = UDim2.new(0, 212, 0, 24)
            dropdownFrame.BorderSizePixel = 0
            dropdownFrame.LayoutOrder = #tabContent:GetChildren() + 1
            dropdownFrame.Parent = tabContent

            local label = Instance.new("TextLabel")
            label.BackgroundTransparency = 1
            label.Position = UDim2.new(0, 4, 0, 0)
            label.Size = UDim2.new(0, 100, 0, 24)
            label.Font = Enum.Font.GothamSemibold
            label.Text = text
            label.TextColor3 = Color3.new(1, 1, 1)
            label.TextSize = 14
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = dropdownFrame

            local selectedIndex = defaultIndex or 1
            Library.flags[text] = items[selectedIndex]

            local dropdownButton = Instance.new("TextButton")
            dropdownButton.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            dropdownButton.BorderSizePixel = 0
            dropdownButton.Position = UDim2.new(1, -100, 0, 0)
            dropdownButton.Size = UDim2.new(0, 96, 0, 24)
            dropdownButton.Font = Enum.Font.GothamSemibold
            dropdownButton.Text = items[selectedIndex]
            dropdownButton.TextColor3 = Color3.new(1, 1, 1)
            dropdownButton.TextSize = 14
            dropdownButton.Parent = dropdownFrame
            dropdownButton.AutoButtonColor = false

            local listOpen = false
            local listFrame = Instance.new("Frame")
            listFrame.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
            listFrame.BorderSizePixel = 0
            listFrame.Position = UDim2.new(0, 0, 1, 4)
            listFrame.Size = UDim2.new(1, 0, 0, 0)
            listFrame.ClipsDescendants = true
            listFrame.Parent = dropdownFrame

            local listLayout = Instance.new("UIListLayout", listFrame)
            listLayout.SortOrder = Enum.SortOrder.LayoutOrder
            listLayout.Padding = UDim.new(0, 2)

            local function toggleList()
                if listOpen then
                    listFrame:TweenSize(UDim2.new(1, 0, 0, 0), Enum.EasingDirection.InOut, Enum.EasingStyle.Sine, 0.25, true)
                    listOpen = false
                else
                    local contentHeight = #items * 24 + (#items - 1) * 2
                    listFrame:TweenSize(UDim2.new(1, 0, 0, contentHeight), Enum.EasingDirection.InOut, Enum.EasingStyle.Sine, 0.25, true)
                    listOpen = true
                end
            end

            dropdownButton.MouseButton1Click:Connect(function()
                safeCall(toggleList)
            end)

            for i, item in ipairs(items) do
                local itemButton = Instance.new("TextButton")
                itemButton.BackgroundColor3 = Color3.fromRGB(43, 43, 43)
                itemButton.BorderSizePixel = 0
                itemButton.Size = UDim2.new(1, 0, 0, 24)
                itemButton.Font = Enum.Font.GothamSemibold
                itemButton.Text = item
                itemButton.TextColor3 = Color3.new(1, 1, 1)
                itemButton.TextSize = 14
                itemButton.Parent = listFrame
                itemButton.AutoButtonColor = false

                itemButton.MouseButton1Click:Connect(function()
                    selectedIndex = i
                    dropdownButton.Text = items[selectedIndex]
                    Library.flags[text] = items[selectedIndex]
                    safeCall(callback, items[selectedIndex])
                    toggleList()
                end)
            end

            return dropdownFrame
        end

        function tabAPI:Label(text)
            local labelFrame = Instance.new("Frame")
            labelFrame.BackgroundTransparency = 1
            labelFrame.Size = UDim2.new(0, 212, 0, 18)
            labelFrame.LayoutOrder = #tabContent:GetChildren() + 1
            labelFrame.Parent = tabContent

            local label = Instance.new("TextLabel")
            label.BackgroundTransparency = 1
            label.Size = UDim2.new(1, 0, 1, 0)
            label.Font = Enum.Font.GothamSemibold
            label.Text = text
            label.TextColor3 = Color3.new(1, 1, 1)
            label.TextSize = 14
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = labelFrame

            return label
        end

        return tabAPI
    end

    return windowAPI
end

return Library
